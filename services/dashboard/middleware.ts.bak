/**
 * Next.js Middleware
 * Handles route protection without polluting components
 * 
 * For homelab/dev mode: allows bypass with DEV_API_KEY
 * For production: requires valid JWT
 */

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

// Public routes that don't require auth
const PUBLIC_ROUTES = [
    '/login',
    '/api/auth/login',
    '/api/auth/logout',
    '/health',
    '/_next',
    '/favicon.ico',
];

// Check if route is public
function isPublicRoute(pathname: string): boolean {
    return PUBLIC_ROUTES.some(route => pathname.startsWith(route));
}

// Check if dev mode bypass is enabled
// When DEV_API_KEY is set, bypass auth entirely (for homelab/dev)
function isDevModeBypass(): boolean {
    const devKey = process.env.DEV_API_KEY;
    // If DEV_API_KEY is set to any non-empty value, bypass auth
    return !!devKey && devKey.length > 0;
}

export function middleware(request: NextRequest) {
    const { pathname } = request.nextUrl;

    // Allow public routes
    if (isPublicRoute(pathname)) {
        return NextResponse.next();
    }

    // Check for dev mode bypass (when DEV_API_KEY is set, skip auth)
    if (isDevModeBypass()) {
        return NextResponse.next();
    }

    // Check for auth token in cookie or header
    const token = request.cookies.get('mother-harness-token')?.value
        || request.headers.get('Authorization')?.replace('Bearer ', '');

    if (!token) {
        // Redirect to login for page requests
        if (!pathname.startsWith('/api/')) {
            const loginUrl = new URL('/login', request.url);
            loginUrl.searchParams.set('redirect', pathname);
            return NextResponse.redirect(loginUrl);
        }
        // Return 401 for API requests
        return new NextResponse(
            JSON.stringify({ error: 'Unauthorized' }),
            { status: 401, headers: { 'Content-Type': 'application/json' } }
        );
    }

    // Token exists - let the request through
    // (Token validation happens on the API side)
    return NextResponse.next();
}

// Configure which routes use this middleware
export const config = {
    matcher: [
        /*
         * Match all request paths except:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         */
        '/((?!_next/static|_next/image|favicon.ico).*)',
    ],
};
